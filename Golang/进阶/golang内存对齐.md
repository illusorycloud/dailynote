# Golang内存对齐

## 1. 对齐规则

在分析之前，我们先看下内存对齐的规则：

1. 对于具体类型来说，**对齐值=min(编译器默认对齐值，类型大小Sizeof长度)**。也就是在默认设置的对齐值和类型的内存占用大小之间，取最小值为该类型的对齐值。我的电脑默认是8，所以最大值不会超过8.
2. struct在每个字段都内存对齐之后，其本身也要进行对齐，**对齐值=min(默认对齐值，字段最大类型长度)**。这条也很好理解，struct的所有字段中，最大的那个类型的长度以及默认对齐值之间，取最小的那个。

在这里再次提醒，对齐值也叫对齐系数、对齐倍数，对齐模数。这就是说，**每个字段在内存中的偏移量是对齐值的倍数即可**。



## 2. 类型长度

windows 64位系统 编译器默认对齐值=8

| 类型                     | 大小 | 对齐系数 | 备注                             |
| ------------------------ | ---- | -------- | -------------------------------- |
| bool                     | 1    | 1        |                                  |
| byte                     | 1    | 1        |                                  |
| int8                     | 1    | 1        |                                  |
| int16                    | 2    | 2        |                                  |
| int32                    | 4    | 4        |                                  |
| int64                    | 8    | 8        |                                  |
| float32                  | 4    | 4        |                                  |
| float64                  | 8    | 8        |                                  |
| map                      | 8    | 8        |                                  |
| string                   | 16   | 8        | 对齐系数不会超过编译器默认对齐值 |
| array ([1]string{"xxx"}) | 16   | 8        |                                  |
| slice ([]string{"xxx"})  | 24   | 8        |                                  |



## 3. 例子

```go
type Part1 struct {
	A bool              // 长度1 偏移0 填充0 总大小1
	B byte              // 长度1 偏移1 填充0 总大小2
	C int8              // 长度1 偏移2 填充0 总大小3
	D int16             // 长度2 偏移3 填充1 总大小6
	E int32             // 长度4 偏移5 填充2 总大小12
	F int64             // 长度8 偏移11 填充4 总大小22
	G float32           // 长度4 偏移21 填充2 总大小28
	H float64           // 长度8 偏移27 填充4 总大小40
	I string            // 长度16 偏移39 填充0 总大小56
	J map[string]string // 长度8 偏移55 填充0 总大小64
	K []string          // 长度24 偏移63 填充0 总大小88
	L [1]string         // 长度16 偏移87 填充0 总大小104
	//104 刚好是8的倍数 不需要填充
}
```

