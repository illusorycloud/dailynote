# Redis缓存相关问题

## 1. 缓存雪崩
### 描述
大面积的缓存key设置了相同的过期时间，导致在同一时间大面积缓存失效，所有请求压力都给到了db。没有其他处理的话基本上直接挂一片。。
### 解决办法
1.批量存key的时候，给过期时间加个随机值，保证数据不会在同一时间过期失效
2.集群部署，将热点数据分布到不同的库。
3.热点数据永不过期，需要的时候直接更新缓存。

## 2. 缓存穿透
### 描述
用户直接请求数据库中都不存在的数据，那缓存中肯定也没有，最终压力还是落到db上。
### 解决办法
1.访问限制 不正常的ip直接拉黑
2.布隆过滤

## 3. 缓存击穿
### 描述
一个key非常热点，大并发集中请求这个key，当这个key失效的一瞬间，大量请求也会落到db上。
和缓存雪崩类似，但是击穿是少数key。
### 解决办法
1.增加互斥锁
2.设置热点数据永不过期



互斥锁伪代码如下

```go
func get(key string) {
	ret := redis.get(Key)
	if ret == nil { // 为空代表缓存值过期
		// 获取锁 同时设置3min的超时，防止del操作失败的时候，下次缓存过期一直不能load db
		setMutex := redis.setnx(key_mutex, 1, 3*60) == 1
		if setMutex {
			// 成功获取锁则load db并回设到缓存
			value = db.get(key)
			redis.set(key, value, expire_secs)
			redis.del(key_mutex)
		} else {
			// 获取失败表示其他请求已经在load db并回设到缓存了 sleep一会然后重试
			time.Sleep(50)
			get(key)
		}
	}
}

```

