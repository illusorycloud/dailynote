# Redis服务器

## 1. 概述

**Redis 命令请求的执行过程**

一个命令请求从发送到获得回复的过程中， 客户端和服务器需要完成一系列操作。

举个例子， 如果我们使用客户端执行以下命令：

```c
redis> SET KEY VALUE
OK
```

那么从客户端发送 `SET KEY VALUE` 命令到获得回复 `OK` 期间， 客户端和服务器共需要执行以下操作：

1. 客户端向服务器发送命令请求 `SET KEY VALUE` 。
2. 服务器接收并处理客户端发来的命令请求 `SET KEY VALUE` ， 在数据库中进行设置操作， 并产生命令回复 `OK` 。
3. 服务器将命令回复 `OK` 发送给客户端。
4. 客户端接收服务器返回的命令回复 `OK` ， 并将这个回复打印给用户观看。



## 2. 具体流程

### 1. 发送请求

当用户在客户端中键入一个命令请求时， 客户端会将这个命令请求转换成协议格式， 然后通过连接到服务器的套接字， 将协议格式的命令请求发送给服务器。

举个例子， 假设客户端执行命令：

```
SET KEY VALUE
```

那么客户端会将这个命令转换成协议：

```
*3\r\n$3\r\nSET\r\n$3\r\nKEY\r\n$5\r\nVALUE\r\n
```

然后将这段协议内容发送给服务器。



### 2. 读取命令请求

当客户端与服务器之间的连接套接字因为客户端的写入而变得可读时， 服务器将调用命令请求处理器来执行以下操作：

1. 读取套接字中协议格式的命令请求， 并将其保存到客户端状态的输入缓冲区里面。
2. 对输入缓冲区中的命令请求进行分析， 提取出命令请求中包含的命令参数， 以及命令参数的个数， 然后分别将参数和参数个数保存到客户端状态的 `argv` 属性和 `argc` 属性里面。
3. 调用命令执行器， 执行客户端指定的命令。

 分析程序将对输入缓冲区中的协议：

```
*3\r\n$3\r\nSET\r\n$3\r\nKEY\r\n$5\r\nVALUE\r\n
```

进行分析， 并将得出的分析结果保存到客户端状态的 `argv` 属性和 `argc` 属性里面。

之后， 服务器将通过调用命令执行器来完成执行命令所需的余下步骤

**命令执行器（1）：查找命令实现**

命令执行器要做的第一件事就是根据客户端状态的 `argv[0]` 参数， 在命令表（command table）中查找参数所指定的命令， 并将找到的命令保存到客户端状态的 `cmd` 属性里面。

命令表是一个字典， 字典的键是一个个命令名字，比如 `"set"` 、 `"get"` 、 `"del"` ，等等； 而字典的值则是一个个 `redisCommand` 结构， 每个`redisCommand` 结构记录了一个 Redis 命令的实现信息

**命令执行器（2）：执行预备操作**

到目前为止， 服务器已经将执行命令所需的命令实现函数（保存在客户端状态的 `cmd` 属性）、参数（保存在客户端状态的 `argv` 属性）、参数个数（保存在客户端状态的 `argc` 属性）都收集齐了， 但是在真正执行命令之前， 程序还需要进行一些预备操作， 从而确保命令可以正确、顺利地被执行， 这些操作包括：

* 1.检查客户端状态的 `cmd` 指针是否指向 `NULL`
* 2.检查命令请求所给定的参数个数是否正确
* 3.检查客户端是否已经通过了身份验证
* 等等

**命令执行器（3）：调用命令的实现函数**

在前面的操作中， 服务器已经将要执行命令的实现保存到了客户端状态的 `cmd` 属性里面， 并将命令的参数和参数个数分别保存到了客户端状态的 `argv` 属性和 `argc` 属性里面， 当服务器决定要执行命令时， 它只要执行以下语句就可以了：

```sh
// client 是指向客户端状态的指针

client->cmd->proc(client);
```

因为执行命令所需的实际参数都已经保存到客户端状态的 `argv` 属性里面了， 所以命令的实现函数只需要一个指向客户端状态的指针作为参数即可。

对于这个例子来说， 执行语句：

```
client->cmd->proc(client);
```

等于执行语句：

```
setCommand(client);
```

被调用的命令实现函数会执行指定的操作， 并产生相应的命令回复， 这些回复会被保存在客户端状态的输出缓冲区里面（`buf` 属性和 `reply`属性）， 之后实现函数还会为客户端的套接字关联命令回复处理器， 这个处理器负责将命令回复返回给客户端。

**命令执行器（4）：执行后续工作**

在执行完实现函数之后， 服务器还需要执行一些后续工作：

- 如果服务器开启了慢查询日志功能， 那么慢查询日志模块会检查是否需要为刚刚执行完的命令请求添加一条新的慢查询日志。
- 根据刚刚执行命令所耗费的时长， 更新被执行命令的 `redisCommand` 结构的 `milliseconds` 属性， 并将命令的 `redisCommand` 结构的 `calls`计数器的值增一。
- 如果服务器开启了 AOF 持久化功能， 那么 AOF 持久化模块会将刚刚执行的命令请求写入到 AOF 缓冲区里面。
- 如果有其他从服务器正在复制当前这个服务器， 那么服务器会将刚刚执行的命令传播给所有从服务器。

当以上操作都执行完了之后， 服务器对于当前命令的执行到此就告一段落了， 之后服务器就可以继续从文件事件处理器中取出并处理下一个命令请求了。

### 3. 将命令回复发送给客户端

 命令实现函数会将命令回复保存到客户端的输出缓冲区里面， 并为客户端的套接字关联命令回复处理器， 当客户端套接字变为可写状态时， 服务器就会执行命令回复处理器， 将保存在客户端输出缓冲区中的命令回复发送给客户端。

当命令回复发送完毕之后， 回复处理器会清空客户端状态的输出缓冲区， 为处理下一个命令请求做好准备。

### 4. 客户端接收并打印命令回复

当客户端接收到协议格式的命令回复之后， 它会将这些回复转换成人类可读的格式， 并打印给用户观看（假设我们使用的是 Redis 自带的`redis-cli` 客户端）

继续以之前的 SET 命令为例子， 当客户端接到服务器发来的 `"+OK\r\n"` 协议回复时， 它会将这个回复转换成 `"OK\n"` ， 然后打印给用户看：

```c
redis> SET KEY VALUE
OK
```

以上就是 Redis 客户端和服务器执行命令请求的整个过程了。

## 3. 小结

- 一个命令请求从发送到完成主要包括以下步骤： 
  - 1.客户端将命令请求发送给服务器；
  - 2.服务器读取命令请求，并分析出命令参数；
  - 3.命令执行器根据参数查找命令的实现函数，然后执行实现函数并得出命令回复； 
  - 4.服务器将命令回复返回给客户端。
- `serverCron` 函数默认每隔 `100` 毫秒执行一次， 它的工作主要包括更新服务器状态信息， 处理服务器接收的 `SIGTERM` 信号， 管理客户端资源和数据库状态， 检查并执行持久化操作， 等等。
- 服务器从启动到能够处理客户端的命令请求需要执行以下步骤： 
  - 1.初始化服务器状态； 
  - 2.载入服务器配置； 
  - 3.初始化服务器数据结构；
  - 4.还原数据库状态；
  - 5.执行事件循环。