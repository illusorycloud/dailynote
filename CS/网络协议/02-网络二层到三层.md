# 底层网络知识二层到三层

* 第一层 物理层

* 第二层（数据链路层）

`MAC`的全称是`Medium Access Control`，即媒体访问控制

```sh
目标mac|源mac| 类型| -------数据------|CRC
 6byte|6byte|2byte|46byte--1500byte|4byte
```

第二层的最开始，就是目标的 MAC 地址和源的 MAC 地址。

有了这个目标MAC地址，数据包在链路上广播，MAC的网卡才能发现是给自己的

接下来是类型

类型：

* 0800：IP数据报
* 0806：ARP请求，应答

大部分的类型是 IP 数据报，然后 IP 里面包含 TCP、UDP，以及 HTTP。

### 接收流程

MAC 的网卡把包收进来，然后打开 IP 包，发现IP地址也是自己的，再打开TCP包，发现端口是自己的，假设是80端口，即NGINX监听的端口。于是将请求提交给NGINX，Nginx返回一个网页，然后将网页返回给请求的机器。返回的时候也是层层封装，来的时候有源MAC地址，返回时则变成了目标MAC地址。

对于以太网，第二层的最后面是CRC，也就是循环冗余检测。通过XOR异或的算法，来计算整个包是否在发送的过程中出现了错误

### 我怎么知道每个 MAC 地址是谁呢

这就是ARP 协议也就是已知 IP 地址，求 MAC 地址的协议。

在一个局域网里面，当知道了 IP 地址，不知道 MAC 怎么办？

* 1.查本地ARP表: 我的IP是`192.168.1.1`MAC是`MAC-A`,IP`192.168.1.2`的MAC是什么
* 2.广播ARP请求: `IP`192.168.1.2`的MAC是什么?`
* 3.ARP应答: 我IP`是192.168.1.2`，我的MAC是MAC-B
* 4.缓存IP-MAC映射:  `192.168.1.2`-`MAC-B`

为了避免每次都用ARP请求，机器本地也会进行ARP缓存。当然机器会不断地上线下线，IP也可能会变，所以ARP的MAC地址缓存过一段时间就会过期。

谁能知道目标MAC地址是否就是连接某个口的电脑的MAC地址呢？这就需要一个能把MAC头拿下来，检查一下目标MAC地址，然后根据策略转发的设备，按第二节课中讲过的，这个设备显然是个二层设备，我们称为交换机。

### 交换机怎么知道每个口的电脑的MAC地址呢？

这需要交换机会学习。

一台MAC1电脑将一个包发送给另一台MAC2电脑，当这个包到达交换机的时候，一开始交换机也不知道MAC2的电脑在哪个口，所以没办法，它只能将包转发给除了来的那个口之外的其他所有的口。

但是，这个时候，交换机会干一件非常聪明的事情，就是交换机会记住，MAC1是来自一个明确的口。以后有包的目的地址是MAC1的，直接发送到这个口就可以了。

当交换机作为一个关卡一样，过了一段时间之后，就有了整个网络的一个结构了，这个时候，基本上不用广播了，全部可以准确转发。当然，每个机器的IP地址会变，所在的口也会变，因而交换机上的学习的结果，我们称为转发表，是有一个过期时间的。

### 小结

* 第一，MAC层是用来解决多路访问的堵车问题的；
* 第二，ARP是通过吼的方式来寻找目标MAC地址的，吼完之后记住一段时间，这个叫作缓存；
* 第三，交换机是有MAC地址学习能力的，学完了它就知道谁在哪儿了，不用广播了。