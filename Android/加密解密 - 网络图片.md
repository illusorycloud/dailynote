#  加密解密

## 1 对称加密

对称加密：**解密的过程是加密的逆过程，两者是对称的。**对称加密时只有一个密钥，通信双方的密钥是相同的。它有DES、AES等加密算法。

> 举例：通信就好像互相发送密码保险箱一样，而且双方必须都有钥匙才能进行加密和解密。也就是说，两个人都拿着保险箱的钥匙，你把数据放进去，用钥匙锁上发给我。我用同样的钥匙把保险箱打开，再把我的数据锁进保险箱，发送给你。大概就这么个样子：

![rsa01.jpg](http://oaarc3d2f.bkt.clouddn.com/rsa01.jpg)

## 2 非对称加密

在采用对称加密时，加密与解密采用相同的算法和密钥，这就说明收发双方需要保存有相同密钥。

这就需要一个安全的通道来传递这个密钥，但实际上这样安全的通道是不方便的或者没有的。

> 举例：为了保证只有通信的AB双方才知道保险箱的密码，只能两个人约好一起去商场买保险箱，再把这个保险箱拿来传输数据。现代通信社会，绝大多数情况下别说一起去买保险箱了，连见个面都难啊，怎么办。所以就有了非对称形式的加密。

非对称加密：**非对称加密的解密过程不是加密的逆过程（两者不对称）。加密算法已知，密文已知依然推不出明文。**非对称加密中会有两个密钥，一个公钥和一个私钥。两个密钥是不相同的，公钥可以公开告诉大家，而私钥则只有自己知道。

## 2.1 可以"撞上"的保险箱

还是拿保险箱来举例：因为没法见面一块买保险箱，于是人们想到了“撞门”的方法。我这有个可以“撞上”的保险箱，你那里自己也买一个这样的保险箱。通信最开始，我把保险箱打开，就这么开着把保险箱发给你。你把数据放进去以后，把保险箱“撞”上发给我。撞上以后，除了我以外，谁都打不开保险箱了。大概是这么个情况：

![rsa02.jpg](http://oaarc3d2f.bkt.clouddn.com/rsa02.jpg)

### 2.2 请第三方来做保险箱

这种锁看起来好像很不错，但是锁在运输的过程中有这么一个严重的问题：你怎么确定你收到的开着的保险箱就是我发来的呢？对于一个心机boy，他完全可以这么做：

1. 装作运输工人。我现在把我开着的保险箱运给对方。运输工人自己也弄这么一个保险箱，运输的时候把保险箱换成他做的。
2. 对方收到保险箱后，没法知道这个保险箱是我最初发过去的，还是运输工人替换的。对方把数据放进去，把保险箱撞上。
3. 运输工人往回运的时候，用自己的钥匙打开自己的保险箱，把数据拿走。然后复印也好，伪造也好，弄出一份数据，把这份数据放进我的保险箱，撞上，然后发给我。

从我的角度，从对方的角度，都会觉得这数据传输过程没问题。但是，运输工人成功拿到了数据，整个过程还是不安全的，大概的过程是这样：

![rsa03.jpg](http://oaarc3d2f.bkt.clouddn.com/rsa03.jpg)

这个问题的本质原因是，人们没办法获知，保险箱到底是“我”做的，还是运输工人做的。那干脆，我们都别做保险箱了，让权威机构做保险箱，然后在每个保险箱上用特殊的工具刻上一个编号。对方收到保险箱的时候，在权威机构的“公告栏”上查一下编号，要是和保险箱上的编号一样，我就知道这个保险箱是“我”的，就安心把数据放进去。大概过程是这样的：

![rsa04.jpg](http://oaarc3d2f.bkt.clouddn.com/rsa04.jpg)

### 2.3 在保险箱上刻个字

如何做出刻上编号，而且编号没法修改的保险箱呢？这涉及到了公钥体制中的另一个问题：**数字签名（Digital Signature）**。

有一天人们想到，我们不一定非要在保险箱上刻规规矩矩的字，规矩的字太容易被模仿，干脆在保险箱上刻手写名字好了。而且，刻字有点麻烦，干脆我们在上面弄张纸，让人直接在上面写，简单不费事。

具体做法是，我们在保险箱上嵌进去一张纸，然后每个出产的保险箱都让权威机构的CEO签上自己的名字。然后，CEO把自己的签名公开在权威机构的“公告栏”上面。比如这个CEO就叫“学酥”，那么整个流程差不多是这个样子：

![rsa05.jpg](http://oaarc3d2f.bkt.clouddn.com/rsa05.jpg)

这个方法的本质原理是，每个人都能够通过笔迹看出保险箱上的字是不是学酥CEO签的。但是呢，这个字体是学酥CEO唯一的字体。别人很难模仿。如果模仿我们就能自己分辨出来了。要是实在分辨不出来呢，我们就请一个笔迹专家来分辨。这不是很好嘛。这个在密码学上就是**数字签名**。

### 2.4 保险箱上刻不相同的字（**带时间戳 / 随机数的签名**，Signature with Timestamp / Randomness） 

上面这个签字的方法虽然好，但是还有一个比较蛋疼的问题。如果每个保险箱上都签相同的名字，那么心机boy也可以去第三方机构买个保险箱，然后中途把你的保险箱换成心机boy刚买的保险箱，反正签名是相同的，对方也看不出来。

人们想到了一个比较好的方法。那就是，学酥CEO签字的时候吧，不光把名字签上，还得带上签字得日期，或者带上这个保险箱的编号。这样一来，每一个保险箱上的签字就唯一了，这个签字是学酥CEO的签名+学酥CEO写上的时间或者编号。这个问题就彻底解决了。这个过程大概是这么个样子：

![rsa06.jpg](http://oaarc3d2f.bkt.clouddn.com/rsa06.jpg)

### 2.5 造价问题（密钥封装机制，Key Encapsulation Mechanism）

解决了上面的各种问题，我们要考虑考虑成本了。 这种能“撞”门的保险箱虽然好，但是这种锁造价一般来说要比普通的锁要高，而且锁生产时间也会变长。在密码学中，对于同样“结实”的锁，能“撞”门的锁的造价一般来说是普通锁的上千倍。同时，能“撞”门的锁一般来说只能安装在小的保险柜里面。毕竟，这么复杂的锁，装起来很费事啊！而普通锁安装在多大的保险柜上面都可以呢。如果两个人想传输大量数据的话，用一个大的保险柜比用一堆小的保险柜慢慢传要好的多呀。

怎么解决这个问题呢？人们又想出了一个非常棒的方法：我们把两种锁结合起来。能“撞”上的保险柜里面放一个普通锁的钥匙。然后造一个用普通的保险柜来锁大量的数据。这样一来，我们相当于用能“撞”上的保险柜发一个钥匙过去。对方收到两个保险柜后，先用自己的钥匙把小保险柜打开，取出钥匙。然后在用这个钥匙开大的保险柜。

![rsa07.jpg](http://oaarc3d2f.bkt.clouddn.com/rsa07.jpg)

### 2.7 小结

以上几个步骤，通过形形色色的锁和解决方案，实现了在公开场合下面做安全的通信。现在网络通信中的过程大致就是如此。

非对称加密中的**公钥**具备**加密数据**和**验证数字签名**的功能。

非对称加密中的**私钥**具备**解密数据**和**制作数字签名**的功能。

非对称加密主要有加密解密和数字签名两种用途：

1. 加密解密：你把公钥告诉全世界，然后对方拿着你的公钥去加密数据，数据发回来之后，只有你自己的私钥才能解密这段数据，这防止了中途有人查看数据。
2. 你用私钥对数据进行签名之后，将公钥和数据、签名发给全世界，对方拿着你的公钥去验证签名，如果通过，这说明数据的确是你发的（因为别人不会有你的私钥），通过签名，可以证明数据的来源，防止有人冒名顶替。

### 2.8 补充

权威机构的作用：每个人都有一对“钥匙”（数字身份），其中一个只有她/他本人知道（密钥），另一个公开的（公钥）。签名的时候用密钥，验证签名的时候用公钥。又因为任何人都可以落款声称她/他就是你，因此公钥必须向接受者信任的人（身份认证机构）来注册。注册后身份认证机构给你发一数字证书（公钥）。对文件签名后，你把此数字证书连同签名后的文件一起发给接受者，接受者向身份认证机构求证是否真地是用你的密钥签发的文件。

## 3 数字摘要

在上节中提到了数字签名，在使用私钥对文件数据进行签名时，如果对整个文件数据的所有字节都进行签名的话，效率太低。

所以在签名时，一般会用一个哈希函数从文件数据中生成一个数据的摘要，然后只对该摘要进行加密形成签名，最后再将形成的签名和文件数据一块给接收者。

然后接收方通过同样的哈希函数从接收到的文件数据生成数据摘要，再拿公钥去解密。

通过这样的方式，如果文件数据中途发生了变更，那数据摘要就会对不上了。

生成数据摘要的算法有SHA1、MD5等。这些算法是单向不可逆的，哪怕更改数据中的一个字母，通过该算法得到的结果都会产生不同的值；它的单向性使得要找到结果值相同的两个不同的数据，在计算上是不可能的。

像某些网盘中的极速秒传，就是借助数字摘要来实现，如果它发现数据库中的已有数据里已经有个文件的数字摘要跟你要上传的文件相同，就认为是同一个文件，它就直接将这个已有文件分享到你的网盘中去了。













