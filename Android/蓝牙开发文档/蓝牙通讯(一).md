**##蓝牙通讯（一）##**

###了解BluetoothAdapter###

**1.作用：**

BluetoothAdapter代表了移动设备的本地的蓝牙适配器, 通过该蓝牙适配器可以对蓝牙进行基本操作, 例如 : 启动设备发现(startDiscovery), 获取已配对设备(getBoundedDevices), 通过mac蓝牙地址获取蓝牙设备(getRemoteDevice), 从其它设备创建一个监听连接(listenUsingRfcommWithServiceRecord);

**2.蓝牙权限（AndrioidManifest所需添加权限）：**

android.permission.BLUETOOTH : 允许程序连接到已配对的蓝牙设备, 请求连接/接收连接/传输数据需要改权限, 主要用于对配对后进行操作;

android.permission.BLUETOOTH_ADMIN : 允许程序发现和配对蓝牙设备, 该权限用来管理蓝牙设备, 有了这个权限, 应用才能使用本机的蓝牙设备, 主要用于对配对前的操作;

优先级 : BLUETOOTH权限是BLUETOOTH_ADMIN权限的前提, 如果没有BLUETOOTH权限, 就不能使用BLUETOOTH_ADMIN权限;

**3.常量值介绍**

**开启蓝牙**：String **ACTION_ REQUEST**,打开蓝牙，值为"android.bluetooth.adapter.action.REQUEST_ENABLE"

    Intent intent = new Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);
    startActivityForResult(intent, requestCode);


可以在Activity中的onActivityResult()方法中处理结果，如果蓝牙模块打开成功，则返回结果码RESULT_OK;如果蓝牙模块打开失败，则返回结果码RESULT_CANCELED;

**蓝牙可见**：String **ACTION_ REQUEST_ DISCOVERABLE**, 使蓝牙可见,值为"android.bluetooth.adapter.action.REQUEST_DISCOVERABLE"

可以在Activity中的onActivityResult()方法中处理结果, 如果蓝牙模块设置可见成功, 则返回结果吗RESULT_OK; 如果蓝牙模块设置可见失败, 则返回结果码RESULT_CANCELED;

    Intent discoverableIntent = new Intent(BluetoothAdapter.ACTION_REQUEST_DISCOVERABLE);
    
    discoverableIntent.putExtra(BluetoothAdapter.EXTRA_DISCOVERABLE_DURATION, 0);
    
    startActivityForResult(discoverableIntent,resultCode)

**蓝牙关闭** : int **STATE_OFF** , 值为10, 蓝牙模块处于关闭状态;

**蓝牙打开中** : int **STATE_ TURNING_ ON** , 值为11, 蓝牙模块正在打开;

**蓝牙开启** : int **STATE_ON** , 值为12, 蓝牙模块处于开启状态;

**蓝牙开启中** : int **STATE_ TURNING_ OFF** , 值为13, 蓝牙模块正在关闭;

**无功能状态** : int **SCAN_MODE_NONE** , 值为20, 查询扫描和页面扫描都失效, 该状态下蓝牙模块既不能扫描其它设备, 也不可见;

**扫描状态** : int **SCAN_ MODE_ CONNECTABLE** , 值为21, 查询扫描失效, 页面扫描有效, 该状态下蓝牙模块可以扫描其它设备, 从可见性来说只对已配对的蓝牙设备可见, 只有配对的设备才能主动连接本设备;

**可见状态** : int **SCAN_ MODE_ CONNECTABLE_ DISCOVERABLE**, 值为23, 查询扫描和页面扫描都有效;

**开始搜索广播** : String **ACTION_ DISCOVERY_ STARTED** ,蓝牙适配器开始搜索远程设备, 值为"android.bluetooth.action.DISCOVERY_START"

如果搜索到蓝牙设备, 就会收到BluetoothDevice.ACTION_FOUND广播, 可以从Intent中获取存放在其中的BluetoothDevice对象, intent.getParcelableExtra(BluetoothDevice.EXTRA_DEVICE);

**搜索完成广播** : String **ACTION_ DISCOVERY_ FINISHED**,蓝牙S适配器完成搜索发出的广播, 值为"android.bluetooth.adapter.action.DISCOVERY_FINISHED", 需要BLUETOOTH权限;

###4.常用用法###
判断蓝牙是否打开然后在onActivityResult中去拿到返回值 判断是否打开蓝牙

	if (!mBluetoothAdapter.isEnabled()) {
	     Intent enableIntent = new Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);
	     startActivityForResult(enableIntent, REQUEST_ENABLE_BT);   
	} 

设置蓝牙可被发现

	if (mBluetoothAdapter.getScanMode() != BluetoothAdapter.SCAN_MODE_CONNECTABLE_DISCOVERABLE) {
            Intent discoverableIntent = new Intent(BluetoothAdapter.ACTION_REQUEST_DISCOVERABLE);
            discoverableIntent.putExtra(BluetoothAdapter.EXTRA_DISCOVERABLE_DURATION, 300);
            startActivity(discoverableIntent);
    }

获取蓝牙列表

1）创建一个蓝牙广播

	private final BroadcastReceiver mReceiver = new BroadcastReceiver() {
        @Override
        public void onReceive(Context context, Intent intent) {
            String action = intent.getAction();
            // 发现设备
            if (BluetoothDevice.ACTION_FOUND.equals(action)) {
                // 获取设备数据
                BluetoothDevice device = intent.getParcelableExtra(BluetoothDevice.EXTRA_DEVICE);
                // 以配对过的设备跳过
                if (device.getBondState() != BluetoothDevice.BOND_BONDED) {
					//添加数据                    
					mNewDevicesArrayAdapter.add(device.getName() + "\n" + device.getAddress());		
                }
                // When discovery is finished, change the Activity title
            } else if (BluetoothAdapter.ACTION_DISCOVERY_FINISHED.equals(action)) {	//扫描结束
                setProgressBarIndeterminateVisibility(false);	//隐藏加载条
                setTitle(R.string.select_device);
                if (mNewDevicesArrayAdapter.getCount() == 0) {
                    String noDevices = getResources().getText(R.string.none_found).toString();
                    mNewDevicesArrayAdapter.add(noDevices);		//
                }
            }
        }
    };

2）在onCreate方法中注册该广播

    // 开始搜索蓝牙
    IntentFilter filter = new IntentFilter(BluetoothDevice.ACTION_FOUND);
    this.registerReceiver(mReceiver, filter);

    // 蓝牙搜索结束
    filter = new IntentFilter(BluetoothAdapter.ACTION_DISCOVERY_FINISHED);
    this.registerReceiver(mReceiver, filter);

3）在onDestory方法中销毁广播

	this.unregisterReceiver(mReceiver);







