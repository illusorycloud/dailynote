# CPU 性能分析小结

## 1. 概述



## 2. CPU 性能指标

### 1. CPU使用率

CPU 使用率描述了非空闲时间占总 CPU 时间的百分比，根据 CPU 上运行任务的不同，又被分为用户 CPU、系统 CPU、等待 I/O CPU、软中断和硬中断等。

* 用户 CPU 使用率，包括用户态 CPU 使用率（user）和低优先级用户态 CPU 使用率（nice），表示 CPU 在用户态运行的时间百分比。用户 CPU 使用率高，通常说明有应用程序比较繁忙。
* 系统 CPU 使用率，表示 CPU 在内核态运行的时间百分比（不包括中断）。系统 CPU 使用率高，说明内核比较繁忙。
* 等待 I/O 的 CPU 使用率，通常也称为 iowait，表示等待 I/O 的时间百分比。iowait 高，通常说明系统与硬件设备的 I/O 交互时间比较长。
* 软中断和硬中断的 CPU 使用率，分别表示内核调用软中断处理程序、硬中断处理程序的时间百分比。它们的使用率高，通常说明系统发生了大量的中断。
* 除了上面这些，还有在虚拟化环境中会用到的窃取 CPU 使用率（steal）和客户 CPU 使用率（guest），分别表示被其他虚拟机占用的 CPU 时间百分比，和运行客户虚拟机的 CPU 时间百分比。



### 2. 平均负载（Load Average）

平均负载（Load Average），也就是系统的平均活跃进程数。它反应了系统的整体负载情况，主要包括三个数值，分别指过去 1 分钟、过去 5 分钟和过去 15 分钟的平均负载。

理想情况下，平均负载等于逻辑 CPU 个数，这表示每个 CPU 都恰好被充分利用。如果平均负载大于逻辑 CPU 个数，就表示负载比较重了。



### 3. 进程上下文切换

进程上下文切换 包括：

* 无法获取资源而导致的自愿上下文切换；
* 被系统强制调度导致的非自愿上下文切换。

上下文切换，本身是保证 Linux 正常运行的一项核心功能。但过多的上下文切换，会将原本运行进程的 CPU 时间，消耗在寄存器、内核栈以及虚拟内存等数据的保存和恢复上，缩短进程真正运行的时间，成为性能瓶颈。



### 4. CPU 缓存命中率

由于 CPU 发展的速度远快于内存的发展，CPU 的处理速度就比内存的访问速度快得多。这样，CPU 在访问内存的时候，免不了要等待内存的响应。为了协调这两者巨大的性能差距，CPU 缓存（通常是多级缓存）就出现了。



## 3. 性能工具

CPU 的性能指标：

| 性能指标          | 工具                                 | 说明                                                         |
| ----------------- | ------------------------------------ | ------------------------------------------------------------ |
| 平均负载          | uptime、top                          | uptime简单，top提供了更全的指标                              |
| 系统整体CPU使用率 | vmstat、mpstat、top、sar、/proc/stat | top、vmstat、 mpstat只可以动态查看，而sar还可以记录历史数据；/proc/stat是其他性能工具的数据来源 |
| 进程CPU使用率     | top、pidstat、ps、htop、atop         | top和ps可以按CPU使用率给进程排序；而pidstat只显示实际用了CPU的进程；ht op和atop以不同颜色显示更直观 |
| 系统上下文切换    | vmstat                               | 系统上下文切换次数，还提供运行状态和不可中断状态进程的数量   |
| 进程上下文切换    | pidstat                              | 注意加上-w 参数                                              |
| 软中断            | top、/proc/softirqs、mpstat          | top提供软中断CPU使用率，而/proc/softirqs和mpstat提供了各种软中断在每个CPU上运行的累计次数 |
| 硬中断            | vmstat、/proc/interrupts             | vmstat提供总的中断次数，而/proc/interrupts提供各种中断在每个CPU上运行的累计次数 |
| 网络              | dstat、sar、tcpdump                  | dstat和sar提供总的网络接收和发送情况，而tcpdump则是动态抓取正在进行的网络 |
| I/O               | dstat、sar                           | dst at和sar都提供了I/O的整体情况                             |
| CPU个数           | /proc/cpuinfo、lscpu                 | lscpu 更直观                                                 |
| 事件剖析          | perf、execsnoop                      | perf可以用来分析CPU的缓存以及内核调用链，execsnoop用 来监控短时进程 |




