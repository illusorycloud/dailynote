# Linux 网络性能优化思路

## 1. 指标

网络性能优化的整体目标，是降低网络延迟（如 RTT）和提高吞吐量（如 BPS 和 PPS），但具体到不同应用中，每个指标的优化标准可能会不同，优先级顺序也大相径庭。

* NAT 网关直接影响整个数据中心的网络出入性能，所以通常需要达到或接近线性转发，也就是说， PPS 是最主要的性能目标。

* 对于数据库、缓存等系统，快速完成网络收发，即低延迟，是主要的性能目标。

* 而对于我们经常访问的 Web 服务来说，则需要同时兼顾吞吐量和延迟。

  

按照网络协议分层不同，关注的性能指标也不同：

* 首先是**网络接口层和网络层**，它们主要负责网络包的封装、寻址、路由，以及发送和接收。**每秒可处理的网络包数 PPS**，就是它们最重要的性能指标（特别是在小包的情况下）。你可以用内核自带的发包工具 pktgen ，来测试 PPS 的性能。

* 再向上到**传输层**的 TCP 和 UDP，它们主要负责网络传输。对它们而言，**吞吐量（BPS）、连接数以及延迟**，就是最重要的性能指标。你可以用 iperf 或 netperf ，来测试传输层的性能。

* 最后，再往上到了**应用层**，最需要关注的是**吞吐量（BPS）、每秒请求数以及延迟**等指标。你可以用 wrk、ab 等工具，来测试应用程序的性能。



## 2. 工具

### 根据指标找工具

| 性能指标       | 工具                         | 说明                                                  |
| -------------- | ---------------------------- | ----------------------------------------------------- |
| 吞吐量（BPS）  | sar<br/>nethogs<br/>iftop    | 分别可以查看网络接口、进程以及IP地址<br/>的网络吞吐量 |
| PPS            | sar<br/>/proc/net/dev        | 查看网络接口的PPS                                     |
| 连接数         | netsta<br/>ss                | 查看网络连接数                                        |
| 延迟           | ping<br/>hping3              | 通过ICMP、TCP等测试网络延迟                           |
|                | conntrack                    | 查看和管理连接跟踪状况                                |
| 路由           | mtr<br/>route<br/>traceroute | 查看路由并测试链路信息                                |
| DNS            | dig<br/>nslookup             | 排查DNS解析问题                                       |
| 防火墙和NAT    | iptables                     | 配置和管理防火墙及NAT规则                             |
| 网卡功能       | ethtool                      | 查看和配置网络接口的功能                              |
| 抓包           | tcpdump<br/>Wireshark        | 抓包分析网络流量                                      |
| 内核协议栈跟踪 | bcc<br/>systemtap            | 动态跟踪内核协议栈的行为                              |



### 根据工具查指标

| 性能工具                                             | 主要功能                    |
| ---------------------------------------------------- | --------------------------- |
| ifconfig<br/>ip                                      | 配置和查看网络接口          |
| ss                                                   | 查看网络连接数              |
| sar<br/>/proc/net/dev/sys/class/net/eth0/statistics/ | 查看网络接口的网络收发情况  |
| nethogs                                              | 查看进程的网络收发情况      |
| iftop                                                | 查看IP的网络收发情况        |
| ethtool                                              | 配置和查看网络接口          |
| conntrack                                            | 查看和管理连接跟踪状况      |
| nslookup<br/>dig                                     | 排查DNS解析问题             |
| mtr<br/>route<br/>traceroute                         | 查看路由并测试链路信息      |
| ping<br/>hping3                                      | 通过ICMP、TCP等测试网络延迟 |
| tcpdump                                              | 网络抓包工具                |
| Wireshark                                            | 网络抓包和图形界面分析工具  |
| iptables                                             | 配置和管理防火墙及NAT规则   |
| perf                                                 | 剖析内核协议栈的性能        |
| systemtap<br/>bcc                                    | 动态追踪内核协议栈的行为    |

