# Linux 内存性能优化思路

## 1. 性能指标

* 1）**系统内存**使用情况：比如已用内存、剩余内存、共享内存、可用内存、缓存和缓冲区的用量等。
  * 缓存包括两部分，一部分是磁盘读取文件的页缓存，用来缓存从磁盘读取的数据，可以加快以后再次访问的速度。另一部分，则是 Slab 分配器中的可回收内存。
  * 缓冲区是对原始磁盘块的临时存储，用来缓存将要写入磁盘的数据。这样，内核就可以把分散的写集中起来，统一优化磁盘写入。

* 2）**进程内存**使用情况：比如进程的虚拟内存、常驻内存、共享内存以及 Swap 内存等。
  * 虚拟内存，包括了进程代码段、数据段、共享内存、已经申请的堆内存和已经换出的内存等。
  * 常驻内存是进程实际使用的物理内存，不过，它不包括 Swap 和共享内存。
  * 共享内存，既包括与其他进程共同使用的真实的共享内存，还包括了加载的动态链接库以及程序的代码段等。
  * Swap 内存，是指通过 Swap 换出到磁盘的内存。

* 3）**Swap **的使用情况：比如 Swap 的已用空间、剩余空间、换入速度和换出速度等。



## 2. 性能工具



### 指标

| 内存指标                         | 性能工具                                 |
| -------------------------------- | ---------------------------------------- |
| 系统已用、可用、剩余内存         | free<br>vmstat<br/>sar<br/>/proc/meminfo |
| 进程虚拟内存、常驻内存、共享内存 | ps<br/>top                               |
| 进程内存分布                     | pmap                                     |
| 进程Swap换出内存                 | top<br/>/proc/{pid}/status               |
| 进程缺页异常                     | ps<br/>top                               |
| 系统换页情况                     | sar                                      |
| 缓存/缓冲用量                    | free<br/>vmstat<br/>sar<br/>cachestat    |
| 缓存/缓冲命中率                  | cachetop                                 |
| SWAP已用空间和剩余空间           | free<br/>sar                             |
| Swap换入换出                     | vmstat                                   |
| 内存泄露检查                     | memleak<br/>valgrind                     |
| 指定文件的缓存大小               | pcstat                                   |



### 工具

| 性能工具                   | 内存指标                                                     |
| -------------------------- | ------------------------------------------------------------ |
| free<br/>/proc/meminfo     | 系统已用、可用、剩余内存以及缓冲区的使用量                   |
| top<br/>ps                 | 进程虚拟内存、常驻内存、共享内存以及缺页异常                 |
| vmstat                     | 系统剩余内存、缓存、缓冲区、换入、换出                       |
| sar                        | 系统内存换页情况、内存使用率、缓存和缓冲区用量以及Swap使用情况 |
| cachestat                  | 系统缓存和缓冲区的命中率                                     |
| cachetop                   | 进程缓存和缓冲区的命中率                                     |
| slabtop                    | 系统Slab缓存使用情况                                         |
| /proc/{pid}/status         | 进程Swap内存等                                               |
| /proc/{pid}/smaps<br/>pmap | 进程地址空间和内存状态                                       |
| valgrind                   | 进程内存错误检查器，用来检测内存初始化、泄漏、越界访问等各种内存错误 |
| memleak                    | 内存泄露检查                                                 |
| pcstat                     | 查看指定文件的缓存情况                                       |



## 3. 思路

为了迅速定位内存问题，可以先运行几个覆盖面比较大的性能工具，比如 free、top、vmstat、pidstat 等。

具体的分析思路主要有这几步：

* 1）先用 free 和 top，查看系统整体的内存使用情况。
* 2）再用 vmstat 和 pidstat，查看一段时间的趋势，从而判断出内存问题的类型。
* 3）最后进行详细分析，比如内存分配分析、缓存 / 缓冲区分析、具体进程的内存使用分析等。



注意事项：

* 1）最好禁止 Swap。如果必须开启 Swap，降低 swappiness 的值，减少内存回收时 Swap 的使用倾向。
* 2）减少内存的动态分配。比如，可以使用内存池、大页（HugePage）等。
* 3）尽量使用缓存和缓冲区来访问数据。比如，可以使用堆栈明确声明内存空间，来存储需要缓存的数据；或者用 Redis 这类的外部缓存组件，优化数据的访问。
* 4）使用 cgroups 等方式限制进程的内存使用情况。这样，可以确保系统内存不会被异常进程耗尽。
* 5）通过 /proc/pid/oom_adj ，调整核心应用的 oom_score。这样，可以保证即使内存紧张，核心应用也不会被 OOM 杀死。