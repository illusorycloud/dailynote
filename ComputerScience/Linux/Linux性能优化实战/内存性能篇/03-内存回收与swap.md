# 内存回收与swap

## 1. 概述

**Swap 说白了就是把一块磁盘空间或者一个本地文件（以下讲解以磁盘为例），当成内存来使用**。它包括换出和换入两个过程。

* 所谓换出，就是把进程暂时不用的内存数据存储到磁盘中，并释放这些数据占用的内存。
* 而换入，则是在进程再次访问这些内存的时候，把它们从磁盘读到内存中来。

Swap 其实是把系统的可用内存变大了。这样，即使服务器的内存不足，也可以运行大内存的应用程序。



## 2. 内存回收

Linux中的内存回收分为**直接内存回收**和**定期内存回收**。

* **直接内存回收**：遇到有新的大块内存分配请求，但是剩余内存不足。这个时候系统就需要回收一部分内存（比如前面提到的缓存），进而尽可能地满足新内存请求，这个过程通常被称为直接内存回收。
* **定期内存回收**：除了直接内存回收，还有一个专门的内核线程用来定期回收内存，也就是 kswapd0。



同时能回收的内存又可以分为**文件页（File-backed Page）**和**匿名页（Anonymous Page）**。

* **文件页**：即缓存和缓冲区。
* **匿名页**：应用程序动态分配的堆内存。



为了衡量内存的使用情况，kswapd0 定义了三个内存阈值（watermark，也称为水位），分别是页最小阈值（pages_min）、页低阈值（pages_low）和页高阈值（pages_high）。剩余内存，则使用 pages_free 表示。

具体关系如下图所示：

![](assets/pages_free.png)

* 剩余内存**小于页最小阈值**，说明进程可用内存都耗尽了，只有内核才可以分配内存。
* 剩余内存落在**页最小阈值和页低阈值中间**，说明内存压力比较大，剩余内存不多了。这时 kswapd0 会执行内存回收，直到剩余内存大于高阈值为止。
* 剩余内存落在**页低阈值和页高阈值中间**，说明内存有一定压力，但还可以满足新内存请求。
* 剩余内存**大于页高阈值**，说明剩余内存比较多，没有内存压力。

**一旦剩余内存小于页低阈值，就会触发内存的回收。**

页低阈值可以通过内核选项 /proc/sys/vm/min_free_kbytes 来间接设置。min_free_kbytes 设置了页最小阈值，而其他两个阈值，都是根据页最小阈值计算生成的，计算方法如下 ：

```sh
pages_low = pages_min*5/4
pages_high = pages_min*3/2
```

具体值可以通过以下命令查看：

```sh
cat /proc/zoneinfo
Node 0, zone    DMA32
  pages free     33162
        min      11168
        low      13960
        high     16752
...
    nr_free_pages 33162
    nr_alloc_batch 1233
    nr_inactive_anon 153878
    nr_active_anon 66489
    nr_inactive_file 44265
    nr_active_file 122585
...
```

* pages 处的 min、low、high，就是上面提到的三个内存阈值，而 free 是剩余内存页数，它跟后面的 nr_free_pages 相同。
* nr_zone_active_anon 和 nr_zone_inactive_anon，分别是活跃和非活跃的匿名页数。
* nr_zone_active_file 和 nr_zone_inactive_file，分别是活跃和非活跃的文件页数。



## 3. NUMA

处理器的 NUMA （Non-Uniform Memory Access）架构也会影响内存回收。

在 NUMA 架构下，多个处理器被划分到不同 Node 上，且每个 Node 都拥有自己的本地内存空间。

而同一个 Node 内部的内存空间，实际上又可以进一步分为不同的内存域（Zone），比如直接内存访问区（DMA）、普通内存区（NORMAL）、伪内存区（MOVABLE）等，如下图所示：

![](assets/NUMA.png)

你可以通过 numactl 命令，来查看处理器在 Node 的分布情况，以及每个 Node 的内存使用情况。

```sh
$ numactl --hardware
available: 1 nodes (0)
node 0 cpus: 0 1
node 0 size: 7977 MB
node 0 free: 4416 MB
...
```



内存不足时有以下几种回收模式：

* 默认的 0 ，表示既可以从其他 Node 寻找空闲内存，也可以从本地回收内存。
* 1、2、4 都表示只回收本地内存，2 表示可以回写脏数据回收内存，4 表示可以用 Swap 方式回收内存。

具体选哪种模式，可以通过 /proc/sys/vm/zone_reclaim_mode 来调整。



## 4. swappiness

回收的内存既包括了文件页，又包括了匿名页。

* 对文件页的回收，当然就是直接回收缓存，或者把脏页写回磁盘后再回收。
* 而对匿名页的回收，其实就是通过 Swap 机制，把它们写入磁盘后再释放内存。

同时Linux 提供了一个  /proc/sys/vm/swappiness 选项，用来调整使用 Swap 的**积极程度**。

> swappiness 的范围是 0-100，数值越大，越积极使用 Swap，也就是更倾向于回收匿名页；数值越小，越消极使用 Swap，也就是更倾向于回收文件页。
>
> 注意：只是调整sw安排的积极程度，就算设置为0也会进行swap。



## 5. 小结

**内存回收方式**

在内存资源紧张时，Linux 通过直接内存回收和定期扫描的方式，来释放文件页和匿名页回收内存。

* 文件页的回收比较容易理解，直接清空，或者把脏数据写回磁盘后再释放。
* 而对匿名页的回收，需要通过 Swap 换出到磁盘中，下次访问时，再从磁盘换入到内存中。

**设置项**

通过设置 /proc/sys/vm/min_free_kbytes，来调整系统定期回收内存的阈值（也就是页低阈值），也可以设置 /proc/sys/vm/swappiness，来调整文件页和匿名页的回收倾向。

**NUMA架构的影响**

在 NUMA 架构下，每个 Node 都有自己的本地内存空间，而当本地内存不足时，默认既可以从其他 Node 寻找空闲内存，也可以从本地内存回收。

你可以设置 /proc/sys/vm/zone_reclaim_mode ，来调整 NUMA 本地内存的回收策略。