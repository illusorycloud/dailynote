# Linux 系统、应用监控

## 1. 系统监控

### 1. USE 法

USE（Utilization Saturation and Errors）把系统资源的性能指标，简化成了三个类别，即使用率、饱和度以及错误数：

* **使用率**，表示资源用于服务的时间或容量百分比。100% 的使用率，表示容量已经用尽或者全部时间都用于服务。
* **饱和度**，表示资源的繁忙程度，通常与等待队列的长度相关。100% 的饱和度，表示资源无法接受更多的请求。
* **错误数**，表示发生错误的事件个数。错误数越多，表明系统的问题越严重。

这三个类别的指标，涵盖了系统资源的常见性能瓶颈，所以常被用来快速定位系统资源的性能瓶颈。

注意：USE 方法只关注能体现系统资源性能瓶颈的核心指标，但这并不是说其他指标不重要。

### 2. 常见指标分类

常见系统资源按照USE分类后对应的性能指标如下表所示。

| 资源        | 类型   | 性能指标                     |
| ----------- | ------ | ---------------------------- |
| CPU         | 使用率 | CPU使用率                    |
|             | 饱和度 | 运行队列长度或平均负载       |
|             | 错误数 | 硬件CPU错误数                |
| 内存        | 使用率 | 已使用内存或者SWAP用量百分比 |
|             | 饱和度 | 内存换页量                   |
|             | 错误数 | 内存分配失败或者OOM          |
| 存储设备I/O | 使用率 | 设备I/O时间百分比            |
|             | 饱和度 | 等待队列长度或延迟           |
|             | 错误数 | I/O错误数                    |
| 文件系统    | 使用率 | 已用容量百分比               |
|             | 饱和度 | 已用容量百分比               |
|             | 错误数 | 文件读写错误数               |
| 网络        | 使用率 | 带宽使用率                   |
|             | 饱和度 | 重传报文数                   |
|             | 错误数 | 网卡收发错误数、丢包数       |
| 文件描述符  | 使用率 | 已用文件描述符百分比         |
| 连接跟踪    | 使用率 | 已用连接跟踪数百分比         |
| 连接数      | 饱和度 | TIMEWAIT状态连接数           |



### 3. 开源监控系统

现在已经有很多开源的监控工具可以直接使用，比如最常见的 Zabbix、Nagios、Prometheus 等等。

当前推荐使用 Prometheus 。



## 2. 应用监控

### 1. 指标监控

应用程序的核心指标如下：

* 请求数
* 错误率
* 响应时间

这些指标不仅直接关系到用户的使用体验，还反映应用整体的可用性和可靠性。

出了核心指标外还有资源相关的几个指标：

* 应用进程的资源使用情况：比如进程占用的 CPU、内存、磁盘 I/O、网络等。
* 应用程序之间调用情况：比如调用频率、错误数、延时等。
* 应用程序内部核心逻辑的运行情况：比如关键环节的耗时以及执行过程中的错误等。

除此之外，由于业务系统通常会涉及到一连串的多个服务，形成一个复杂的分布式调用链。为了迅速定位这类跨应用的性能瓶颈，你还可以使用 Zipkin、Jaeger、Pinpoint 等各类开源工具，来构建全链路跟踪系统。

> Go 生态推荐使用 Jaeger

### 2. 日志监控

对日志监控来说，最经典的方法，就是使用 ELK 技术栈，即使用 Elasticsearch、Logstash 和 Kibana 这三个组件的组合。

值得注意的是，ELK 技术栈中的 Logstash 资源消耗比较大。所以，在资源紧张的环境中，我们往往使用资源消耗更低的 Fluentd，来替代 Logstash（也就是所谓的 EFK 技术栈）。